{% extends "base.html" %}

{% block title %}ç¼–è¾‘é—®å· - é—®å·è°ƒæŸ¥ç³»ç»Ÿ{% endblock %}

{% block content %}
<h1>ç¼–è¾‘é—®å·</h1>

<div class="breadcrumb">
    <a href="{{ url_for('admin_dashboard') }}">ç®¡ç†é¦–é¡µ</a> > 
    <a href="{{ url_for('admin_surveys') }}">é—®å·ç®¡ç†</a> > ç¼–è¾‘é—®å·
</div>

<div style="max-width: 700px;">
    <div class="card">
        <div class="card-body">
            <form method="post">
                <div class="form-group">
                    <label>é—®å·ID:</label>
                    <input type="text" value="{{ survey.survey_id }}" disabled style="background-color: #e9ecef;">
                    <small style="color: #666;">é—®å·IDä¸å¯ä¿®æ”¹</small>
                </div>
                
                <div class="form-group">
                    <label for="title">é—®å·æ ‡é¢˜:</label>
                    <input type="text" id="title" name="title" value="{{ survey.title }}" required>
                    <small style="color: #666;">æ˜¾ç¤ºç»™ç”¨æˆ·çš„é—®å·æ ‡é¢˜</small>
                </div>
                
                <div class="form-group">
                    <label for="description">é—®å·æè¿°:</label>
                    <textarea id="description" name="description" rows="3">{{ survey.description or '' }}</textarea>
                </div>
                
                <div class="form-group">
                    <label>è®¿é—®æƒé™:</label>
                    <div>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="radio" name="access_type" value="all" 
                                   {% if survey.access_type == 'all' %}checked{% endif %}
                                   onchange="toggleGroupSelection()"> 
                            å…¨å‘˜å¯è§ - æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®æ­¤é—®å·
                        </label>
                        <label style="display: block;">
                            <input type="radio" name="access_type" value="groups" 
                                   {% if survey.access_type == 'groups' %}checked{% endif %}
                                   onchange="toggleGroupSelection()"> 
                            ç»„ç»‡é™åˆ¶ - ä»…æŒ‡å®šç»„ç»‡çš„ç”¨æˆ·å¯ä»¥è®¿é—®
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="group-selection" 
                     style="{% if survey.access_type != 'groups' %}display: none;{% endif %}">
                    <label>é€‰æ‹©å¯è®¿é—®çš„ç»„ç»‡:</label>
                    <div class="tree-selector" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 4px; background-color: #fafafa;">
                        {% for group in all_groups %}
                            <div class="tree-node" data-level="{{ group.full_path.count('/') if '/' in group.full_path else 0 }}" style="margin-left: {{ (group.full_path.count('/') if '/' in group.full_path else 0) * 20 }}px; margin-bottom: 8px;">
                                <div class="tree-item" style="display: flex; align-items: center; padding: 5px; border-radius: 3px; transition: background-color 0.2s;">
                                    {% if group.full_path.count('/') > 0 %}
                                        <span class="tree-connector" style="margin-right: 8px; color: #999;">â””â”€</span>
                                    {% endif %}
                                    <label style="display: flex; align-items: center; margin: 0; cursor: pointer; flex: 1;">
                                        <input type="checkbox" name="selected_groups" value="{{ group.id }}"
                                               {% if group.id|string in current_group_ids %}checked{% endif %}
                                               style="margin-right: 8px;">
                                        <span class="group-icon" style="margin-right: 6px; color: #007bff;">
                                            {% if group.full_path.count('/') == 0 %}ğŸ¢{% else %}ğŸ“{% endif %}
                                        </span>
                                        <span class="group-name" style="font-weight: {% if group.full_path.count('/') == 0 %}bold{% else %}normal{% endif %};">
                                            {{ group.name }}
                                        </span>
                                        {% if group.description %}
                                            <small style="margin-left: 8px; color: #666;">({{ group.description }})</small>
                                        {% endif %}
                                    </label>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div style="margin-top: 10px;">
                        <button type="button" class="btn" style="font-size: 12px; padding: 5px 10px;" onclick="selectAllGroups()">å…¨é€‰</button>
                        <button type="button" class="btn" style="font-size: 12px; padding: 5px 10px;" onclick="clearAllGroups()">æ¸…ç©º</button>
                        <button type="button" class="btn btn-warning" style="font-size: 12px; padding: 5px 10px;" onclick="selectRootGroups()">ä»…é€‰æ ¹ç»„ç»‡</button>
                    </div>
                    <small style="color: #666;">é€‰æ‹©å¯ä»¥è®¿é—®æ­¤é—®å·çš„ç»„ç»‡ï¼Œå­ç»„ç»‡ç”¨æˆ·å¯ä»¥è®¿é—®çˆ¶ç»„ç»‡çš„é—®å·</small>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="is_active" {% if survey.is_active %}checked{% endif %}> 
                        æ¿€æ´»æ­¤é—®å·
                    </label>
                    <small style="display: block; color: #666;">åªæœ‰æ¿€æ´»çš„é—®å·æ‰ä¼šæ˜¾ç¤ºç»™ç”¨æˆ·</small>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-success">ä¿å­˜ä¿®æ”¹</button>
                    <a href="{{ url_for('admin_surveys') }}" class="btn">å–æ¶ˆ</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleGroupSelection() {
    var accessType = document.querySelector('input[name="access_type"]:checked').value;
    var groupSelection = document.getElementById('group-selection');
    
    if (accessType === 'groups') {
        groupSelection.style.display = 'block';
    } else {
        groupSelection.style.display = 'none';
        // å–æ¶ˆæ‰€æœ‰ç»„ç»‡çš„é€‰æ‹©
        var checkboxes = document.querySelectorAll('input[name="selected_groups"]');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = false;
        });
    }
}

function selectAllGroups() {
    var checkboxes = document.querySelectorAll('input[name="selected_groups"]');
    checkboxes.forEach(function(checkbox) {
        checkbox.checked = true;
    });
}

function clearAllGroups() {
    var checkboxes = document.querySelectorAll('input[name="selected_groups"]');
    checkboxes.forEach(function(checkbox) {
        checkbox.checked = false;
    });
}

function selectRootGroups() {
    var checkboxes = document.querySelectorAll('input[name="selected_groups"]');
    checkboxes.forEach(function(checkbox) {
        var treeNode = checkbox.closest('.tree-node');
        var level = parseInt(treeNode.getAttribute('data-level'));
        checkbox.checked = (level === 0);
    });
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    toggleGroupSelection();
    
    // æ·»åŠ æ‚¬åœæ•ˆæœ
    var treeItems = document.querySelectorAll('.tree-item');
    treeItems.forEach(function(item) {
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
        });
        item.addEventListener('mouseleave', function() {
            var checkbox = this.querySelector('input[type="checkbox"]');
            if (checkbox.checked) {
                this.style.backgroundColor = '#e8f5e8';
            } else {
                this.style.backgroundColor = 'transparent';
            }
        });
    });
    
    // ä¸ºé€‰ä¸­çš„é¡¹ç›®æ·»åŠ ç‰¹æ®Šæ ·å¼
    var checkboxes = document.querySelectorAll('input[name="selected_groups"]');
    checkboxes.forEach(function(checkbox) {
        // åˆå§‹åŒ–å·²é€‰ä¸­é¡¹ç›®çš„æ ·å¼
        var treeItem = checkbox.closest('.tree-item');
        if (checkbox.checked) {
            treeItem.style.backgroundColor = '#e8f5e8';
            treeItem.style.border = '1px solid #4caf50';
        }
        
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                treeItem.style.backgroundColor = '#e8f5e8';
                treeItem.style.border = '1px solid #4caf50';
            } else {
                treeItem.style.backgroundColor = 'transparent';
                treeItem.style.border = 'none';
            }
        });
    });
});
</script>
{% endblock %}